<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Mining Stats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Solo CKPool Lotto Dashboard</h1>
      <p class="text-slate-400 text-sm">
        Address:
        <span id="address" class="font-mono"></span>
      </p>
      <p class="text-slate-400 text-xs mt-1">
        Data live from <code class="font-mono">solo.ckpool.org</code>
      </p>
    </header>

    <!-- Status / Errors -->
    <div id="status" class="mb-4 text-sm text-slate-300"></div>

    <!-- Main stats -->
    <div id="main-stats" class="grid gap-4 md:grid-cols-3 mb-6"></div>

    <!-- Hashrate cards -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Hashrate</h2>
      <div id="hashrate-cards" class="grid gap-4 md:grid-cols-5"></div>
    </div>
        <!-- Odds -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Odds to Find a BTC Block</h2>
      <div id="odds-cards" class="grid gap-4 md:grid-cols-4"></div>
    </div>


    <!-- Worker stats -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Workers</h2>
      <div id="workers" class="grid gap-4 md:grid-cols-2"></div>
    </div>

    <footer class="mt-10 text-xs text-slate-500">
      Auto-refreshes every 30 seconds. Just a personal lotto-mining toy :)
    </footer>
  </div>

    <script>
    // === CONFIG ===
    const BTC_ADDRESS = "bc1qa38m29hprs809kxnddsd03jwlq7p6sru7saw06";
    const API_URL =
      "https://solopooldash.jesf777.workers.dev/ckpool/" + BTC_ADDRESS;
    const BTC_DIFF_URL =
      "https://solopooldash.jesf777.workers.dev/difficulty/btc";
    const BCH_DIFF_URL =
      "https://solopooldash.jesf777.workers.dev/difficulty/bch";

    const REFRESH_INTERVAL_MS = 30000;

    document.getElementById("address").textContent = BTC_ADDRESS;

    function formatTimestamp(ts) {
      if (!ts) return "N/A";
      const d = new Date(ts * 1000);
      return d.toLocaleString();
    }

    function timeSince(ts) {
      if (!ts) return "N/A";
      const seconds = Math.floor(Date.now() / 1000) - ts;
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function createCard(title, value, subtitle = "") {
      const div = document.createElement("div");
      div.className =
        "bg-slate-800/70 border border-slate-700 rounded-xl p-4 flex flex-col gap-1";
      div.innerHTML = `
        <p class="text-xs uppercase tracking-wide text-slate-400">${title}</p>
        <p class="text-xl font-semibold">${value}</p>
        ${
          subtitle
            ? `<p class="text-xs text-slate-400">${subtitle}</p>`
            : ""
        }
      `;
      return div;
    }

    // Parse hashrate like "44.6T", "11.7P", etc → hashes/second
    function parseHashrate(hrString) {
      if (!hrString) return null;
      const match = /([\d.]+)\s*([kMGTPE])?/i.exec(hrString);
      if (!match) return null;
      const num = parseFloat(match[1]);
      if (!Number.isFinite(num)) return null;
      const unit = (match[2] || "").toUpperCase();
      const multipliers = {
        "": 1,
        K: 1e3,
        M: 1e6,
        G: 1e9,
        T: 1e12,
        P: 1e15,
        E: 1e18,
      };
      return num * (multipliers[unit] || 1);
    }

    function calcOdds(hashrateHs, difficulty) {
      if (!hashrateHs || !difficulty) return null;

      const hashesPerBlock = difficulty * Math.pow(2, 32); // BTC PoW relation
      const lambdaPerSecond = hashrateHs / hashesPerBlock; // expected blocks / sec

      const SECS_DAY = 86400;
      const SECS_WEEK = 7 * SECS_DAY;
      const SECS_MONTH = 30 * SECS_DAY;
      const SECS_YEAR = 365 * SECS_DAY;

      function probOver(seconds) {
        const lambda = lambdaPerSecond * seconds;
        return 1 - Math.exp(-lambda);
      }

      return {
        day: probOver(SECS_DAY),
        week: probOver(SECS_WEEK),
        month: probOver(SECS_MONTH),
        year: probOver(SECS_YEAR),
        expectedSeconds: 1 / lambdaPerSecond,
      };
    }

    function formatProbability(p) {
      if (!p || p <= 0) return "0%";
      const pct = p * 100;
      let pctStr;
      if (pct >= 0.1) pctStr = pct.toFixed(2) + "%";
      else pctStr = pct.toFixed(4) + "%";

      const oneIn = Math.round(1 / p);
      return `${pctStr} (~1 in ${oneIn.toLocaleString()})`;
    }

    function formatDuration(seconds) {
      if (!seconds || !Number.isFinite(seconds)) return "N/A";
      const days = seconds / 86400;
      if (days < 1) return `${seconds.toFixed(1)} s`;
      if (days < 7) return `${days.toFixed(1)} days`;
      const weeks = days / 7;
      if (weeks < 52) return `${weeks.toFixed(1)} weeks`;
      const years = days / 365;
      return `${years.toFixed(2)} years`;
    }

    async function loadStats() {
      const statusEl = document.getElementById("status");
      const mainStatsEl = document.getElementById("main-stats");
      const hashrateEl = document.getElementById("hashrate-cards");
      const workersEl = document.getElementById("workers");
      const oddsEl = document.getElementById("odds-cards");

      statusEl.textContent = "Loading latest stats…";

      try {
        const [statsRes, btcDiffRes, bchDiffRes] = await Promise.all([
          fetch(API_URL),
          fetch(BTC_DIFF_URL).catch(() => null),
          fetch(BCH_DIFF_URL).catch(() => null),
        ]);

        if (!statsRes.ok) throw new Error(`CKPool HTTP ${statsRes.status}`);

        const data = await statsRes.json();
        const btcDiffData = btcDiffRes && btcDiffRes.ok
          ? await btcDiffRes.json()
          : null;
        const bchDiffData = bchDiffRes && bchDiffRes.ok
          ? await bchDiffRes.json()
          : null;

        const btcDifficulty = btcDiffData?.difficulty || null;
        const bchDifficulty = bchDiffData?.difficulty || null;

        statusEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

        // Clear containers
        mainStatsEl.innerHTML = "";
        hashrateEl.innerHTML = "";
        workersEl.innerHTML = "";
        oddsEl.innerHTML = "";

        // === MAIN STATS ===
        mainStatsEl.appendChild(
          createCard(
            "Best Share (Current Session)",
            data.bestshare.toLocaleString(),
            "Higher = closer to winning block"
          )
        );

        mainStatsEl.appendChild(
          createCard(
            "Best Share (All Time)",
            data.bestever.toLocaleString(),
            ""
          )
        );

        mainStatsEl.appendChild(
          createCard(
            "Total Shares",
            data.shares.toLocaleString(),
            `Workers: ${data.workers}`
          )
        );

        // Network difficulty cards (BTC & BCH)
        if (btcDifficulty) {
          mainStatsEl.appendChild(
            createCard(
              "BTC Difficulty",
              btcDifficulty.toLocaleString(undefined, {
                maximumFractionDigits: 0,
              }),
              ""
            )
          );
        }

        if (bchDifficulty) {
          mainStatsEl.appendChild(
            createCard(
              "BCH Difficulty",
              bchDifficulty.toLocaleString(undefined, {
                maximumFractionDigits: 0,
              }),
              ""
            )
          );
        }

        // === HASHRATE CARDS ===
        const hrLabels = {
          hashrate1m: "1 min",
          hashrate5m: "5 min",
          hashrate1hr: "1 hour",
          hashrate1d: "1 day",
          hashrate7d: "7 days",
        };

        Object.entries(hrLabels).forEach(([field, label]) => {
          const val = data[field];
          if (!val) return;
          hashrateEl.appendChild(
            createCard(label, val, "reported by CKPool")
          );
        });

        // === WORKER CARDS ===
        if (Array.isArray(data.worker)) {
          data.worker.forEach((w) => {
            const card = document.createElement("div");
            card.className =
              "bg-slate-800/70 border border-slate-700 rounded-xl p-4 flex flex-col gap-2";

            card.innerHTML = `
              <p class="text-xs uppercase tracking-wide text-slate-400">Worker</p>
              <p class="font-mono text-sm break-all">${w.workername}</p>

              <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                <div>
                  <p class="text-xs text-slate-400">1m</p>
                  <p class="font-semibold">${w.hashrate1m}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-400">5m</p>
                  <p class="font-semibold">${w.hashrate5m}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-400">1h</p>
                  <p class="font-semibold">${w.hashrate1hr}</p>
                </div>
                <div>
                  <p class="text-xs text-slate-400">1d</p>
                  <p class="font-semibold">${w.hashrate1d}</p>
                </div>
              </div>

              <div class="mt-3 text-xs text-slate-400">
                <p>Last share: <span class="text-slate-200">
                  ${timeSince(w.lastshare)} (${formatTimestamp(w.lastshare)})
                </span></p>
                <p>Session shares: <span class="text-slate-200">
                  ${w.shares.toLocaleString()}
                </span></p>
                <p>Best share: <span class="text-slate-200">
                  ${w.bestshare.toLocaleString()}
                </span></p>
              </div>
            `;

            workersEl.appendChild(card);
          });
        }

        // === ODDS SECTION === (BTC only, using 1-day hashrate)
        if (btcDifficulty && data.hashrate1d) {
          const hrHs = parseHashrate(data.hashrate1d);
          const odds = calcOdds(hrHs, btcDifficulty);

          if (odds) {
            oddsEl.appendChild(
              createCard(
                "Chance in 1 day",
                formatProbability(odds.day),
                `Using 1-day hashrate: ${data.hashrate1d}`
              )
            );
            oddsEl.appendChild(
              createCard("Chance in 1 week", formatProbability(odds.week))
            );
            oddsEl.appendChild(
              createCard("Chance in 1 month", formatProbability(odds.month))
            );
            oddsEl.appendChild(
              createCard(
                "Chance in 1 year",
                formatProbability(odds.year),
                `Expected time to hit a block: ${formatDuration(
                  odds.expectedSeconds
                )}`
              )
            );
          }
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent =
          "Error loading stats (maybe CORS, network, or diff API). Check console.";
      }
    }

    loadStats();
    setInterval(loadStats, REFRESH_INTERVAL_MS);
  </script>

</body>
</html>
